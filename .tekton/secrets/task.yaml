apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: task
spec:
  params:
    - name: repository
      description: the git repo
    - name: revision
      description: the revision
      default: master
  workspaces:
  - name: task-pvc
    mountPath: /artifacts
  steps:
    - name: clone-repo
      image: alpine/git
      env:
        - name: REPOSITORY
          value: $(params.repository)
        - name: REVISION
          value: $(params.revision)
        - name: USERNAME
          value: idsorg
        - name: GIT_TOKEN
          valueFrom:
            secretKeyRef:
              name: user-secret
              key: git_token
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e -o pipefail
          rm -f ~/.netrc
          cat > ~/.netrc <<NETRC
          machine github.ibm.com
          login ${USERNAME}
          password ${GIT_TOKEN}
          NETRC
          chmod 600 ~/.netrc

          echo "Cloning $REPOSITORY"
          cd /workspace
          git clone -q -b $REVISION $REPOSITORY .
          rm -f ~/.netrc